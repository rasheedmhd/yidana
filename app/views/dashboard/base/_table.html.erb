<%#
  locals: {
    resources: "list of resources to render",
    resource_class: "Class of resources being rendered",
    pagy: "pagy instance",
    columns: Array(
      "field_name",

      OR

      {
        name: "field name",
        type: "custom type to render",
        transformer: "value transformer. must respond to #call"
      }
    )
  }
%>
<%
  columns = columns.map do |column|
    case column
    when Hash
      name = column.delete :name
    else
      name = column
      column = {}
    end

    column_definition = resource_class.columns_hash[name.to_s]
    name = name.to_sym
    properties = {
      name: name,
      type: column_definition&.type,
      transformer: local_assigns[:transformer_factory].present? ? transformer_factory.call(name) : nil
    }.update column

    [name, properties]
  end.to_h
  columns.delete :id
%>
<div class="row">
  <% unless resources.any? %>
    <div class="col-12">
      <%=
        render 'empty_card', message: "You have no #{resources_name(resource_class).downcase}" do
          next unless can_perform?(resource_class, :create)

          link_to "Create #{resource_name(resource_class)}", path_for(resource_class, :new), class: 'btn btn-outline-primary'
        end
      %>
    </div>
  <% else %>
    <div class="col-12 table-responsive max-vh-75">
      <table class="table table-hover table-striped my-0">
        <thead class="sticky-top">
          <tr>
            <th scope="col" style="min-width: 40px">#</th>
            <% columns.keys.each do |name| %>
              <th scope="col" style="min-width: 150px;"><%= attribute_name resource_class, name %></th>
            <% end  %>
            <th scope="col"style="min-width: 150px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% resources.each do |resource| %>
          <tr class="align-middle">
            <td><%= resource.id %></td>

            <% columns.each do |name, properties| %>
              <% can_read_field? resource, name do %>
                <%= render partial: 'table_cell', locals: { value: resource.send(name), **properties } %>
              <% end %>
            <% end  %>

            <td style="white-space: nowrap;">
              <%= show_button_for(resource, :primary, variant: :table) %>
              <%= edit_button_for(resource, :secondary, variant: :table) %>
              <%= delete_button_for(resource, variant: :table) %>
            </td>
          </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    <% unless pagy.nil?  %>
      <div class="col-12">
        <%= pagination pagy %>
      </div>
    <% end  %>
  <% end %>
</div>
